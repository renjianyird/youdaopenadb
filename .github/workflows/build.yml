name: 自动构建 + 自动版本 + 自动发布 Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 生成自动版本号 2.0 → 2.1 → 2.2
        id: calc_ver
        shell: pwsh
        run: |
          $base = 2.0
          $ver = [math]::Round($base + ${{ github.run_number }}/10, 1)
          echo "build_version=$ver" >> $env:GITHUB_OUTPUT

      - name: 自动把版本号写入代码
        shell: pwsh
        run: |
          (Get-Content YoudaoADB_Full1Auto.py) -replace 'VERSION = ".*?"','VERSION = "${{ steps.calc_ver.outputs.build_version }}"' | Set-Content YoudaoADB_Full1Auto.py

      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install requests scapy pyinstaller

      - name: 编译单文件 EXE
        run: |
          pyinstaller -F -c YoudaoADB_Full1Auto.py
          ren dist\YoudaoADB_Full1Auto.exe YoudaoADB_Full1Auto_v${{ steps.calc_ver.outputs.build_version }}.exe

      - name: 发布 Release
        uses: softprops/softprops-gh-release@v2
        with:
          tag_name: v${{ steps.calc_ver.outputs.build_version }}
          name: 有道词典笔ADB全自动工具 v${{ steps.calc_ver.outputs.build_version }}
          body: |
            ✅ 自动构建版本：v${{ steps.calc_ver.outputs.build_version }}
            ✅ 作者：喂鸡 (Wei Ji)
            ✅ 自动抓包 | 自动下载 | 自动修改
            ✅ 已修复：解析固件地址失败导致闪退问题
            © 2026 喂鸡 (Wei Ji) 版权所有
          files: dist/YoudaoADB_Full1Auto_v${{ steps.calc_ver.outputs.build_version }}.exe
